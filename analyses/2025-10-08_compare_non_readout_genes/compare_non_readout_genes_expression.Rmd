---
title: "compare_non_readout_genes_expression"
output: html_document
---

# Compare non-readout genes with high expression in hiPSC-EC day 0 vs hiPSC-HPC day 0

The genes for the comparison did not have inner primer designed against them and
have a CPM > 100.

## Load the data

```{r}
# Loading the non-readout genes with high expression in hiPSC-EC day 0
hiPSC_EC_day0 <- read.table("../../results/2025-10-07_ec_sceptre_analysis/high_cpm_non_readout_genes.tsv", header = TRUE)
message("Columns in the data: ", paste(colnames(hiPSC_EC_day0), collapse = ", "))


message("Number of genes for hiPSC-EC day 0: ", length(hiPSC_EC_day0$gene))
# Annotate the ribosomal genes matching pattern  "^RPS|^RPL|^RRP|^MRP|^FAU"
hiPSC_EC_day0$is_ribosomal <- grepl("^RPS|^RPL|^RRP|^MRP|^FAU", hiPSC_EC_day0$gene_symbol)
message("Number of ribosomal genes: ", sum(hiPSC_EC_day0$is_ribosomal))

# Loading the non-readout genes with high expression in hiPSC-HPC day 0
hiPSC_HPC_day0 <- read.table("../../../broad-hgrm-wtc11-modeling-challenge/results/2025-09-18/high_cpm_non_readout_genes.tsv", header = TRUE)
message("Number of genes for hiPSC-HPC day 0: ", length(hiPSC_HPC_day0$gene))
hiPSC_HPC_day0$is_ribosomal <- grepl("^RPS|^RPL|^RRP|^MRP|^FAU", hiPSC_HPC_day0$gene_symbol)
message("Number of ribosomal genes: ", sum(hiPSC_HPC_day0$is_ribosomal))

message("Number of overlapping genes: ", length(intersect(hiPSC_EC_day0$gene, hiPSC_HPC_day0$gene)))
overlapping_genes <- intersect(hiPSC_EC_day0$gene, hiPSC_HPC_day0$gene)
```

Create a dataframe with only the overlapping genes, merge the two dataframes by gene,
calculate the difference in mean CPM, sort by the difference in mean CPM in descending order.
```{r}
# Create dataframe with only overlapping genes
hiPSC_EC_day0_overlap <- hiPSC_EC_day0[hiPSC_EC_day0$gene %in% overlapping_genes, ]
hiPSC_HPC_day0_overlap <- hiPSC_HPC_day0[hiPSC_HPC_day0$gene %in% overlapping_genes, ]
# Merge the two dataframes by gene
merged_df <- merge(hiPSC_EC_day0_overlap, hiPSC_HPC_day0_overlap, by = "gene_symbol", suffixes = c("_EC", "_HPC"))
# Calculate the difference in mean CPM
merged_df$mean_cpm_diff <- merged_df$mean_cpm_EC - merged_df$mean_cpm_HPC
# Sort by the difference in mean CPM  in descending order
merged_df <- merged_df[order(-merged_df$mean_cpm_diff), ]
# Mark ribosomal genes matching pattern  "^RPS|^RPL|^RRP|^MRP|^FAU"
merged_df$is_ribosomal <- merged_df$is_ribosomal_EC
message("Number of ribosomal genes: ", sum(merged_df$is_ribosomal))
head(merged_df)
```

# Ribosomal genes statistics
```{r}
message("Ribosomal genes in the overlapping set:")
print(merged_df[merged_df$is_ribosomal,"gene_symbol"])
message("Ribosomal genes in hiPSC-EC day 0 only:")
print(hiPSC_EC_day0[hiPSC_EC_day0$is_ribosomal & !(hiPSC_EC_day0$gene %in% overlapping_genes),"gene_symbol"])
message("Ribosomal genes in hiPSC-HPC day 0 only:")
print(hiPSC_HPC_day0[hiPSC_HPC_day0$is_ribosomal & !(hiPSC_HPC_day0$gene %in% overlapping_genes),"gene_symbol"])
```


Plot the mean CPM of the overlapping genes in hiPSC-EC day 0 vs hiPSC-HPC day 0
```{r}
plot(log10(merged_df$mean_cpm_EC), log10(merged_df$mean_cpm_HPC),
     xlab = "Mean CPM in hiPSC-EC day 0",
     ylab = "Mean CPM in hiPSC-HPC day 0",
     main = "Mean CPM of overlapping non-readout genes",
     xlim = c(2, 5),
     pch = 16, col = ifelse(merged_df$is_ribosomal, "red", "black"))
abline(0, 1, col = "blue", lty = 2)
legend("topright", legend = c("Ribosomal genes", "Other genes"), col = c("red", "black"), pch = 16)
```

